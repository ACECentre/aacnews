{% extends 'admin/master.html' %}

{% block head_css %}
        {{ super() }}
        <link href="{{ url_for('static', filename='styles.css') }}" rel="stylesheet">
{% endblock %}

{% block body %}
{{ super() }}

    <script type="text/javascript">
      function send_email() {
        $.ajax({
          type: "POST",
          url: "{{ url_for('emailview.email_send_action') }}",
          data: { spoiler: "{{ spoiler }}", title: "{{ title }}", preamble : $("#preamble").val(), content : $("#content_html").val(), cid : "{{ cid }}", ids : "{{ ids }}" },
          success: function(msg) {
                      if (msg == "completed"){
                          $('#notificationSuccessModal').modal({
                            backdrop: 'static'
                          })
                      }
                      else{
                        show_error_modal();
                      }
          },
          error: function() {
              show_error_modal();
          }
        });
      }
      function cancel_email() {
        $("#email_cancel_form").submit();
      }

      function show_error_modal() {
        $('#notificationErrorModal').modal({
            backdrop: 'static'
          })
      }

    </script>

    <div>
        {{ template_content|safe }}
    </div>
    <div class="buttons-email-preview">
        <a class="btn btn-danger pull-right" onclick="cancel_email(); return false;">Cancel</a>
        <a class="btn btn-success pull-right" onclick="send_email(); return false;">Send</a>
    </div>

    <input id="content_html" type="hidden" name="content" value="{{ template_content }}"/>
    <input id="preamble" type="hidden" name="preamble" value="{{ preamble }}"/>

    <form id="email_cancel_form" method="post" action="{{ url_for('emailview.email_cancel_action') }}">
    	<input type="hidden" name="cid" value="{{ cid }}"/>
    </form>

    <div id="notificationSuccessModal" class="modal fade">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal"></button>
            <h4 class="modal-title">Message</h4>
          </div>
          <div class="modal-body">
            <p>Notification was sent successfully.</p>
          </div>
          <div class="modal-footer">
            <a href="{{ url_for('emailview.index_view') }}" class="btn btn-primary">Ok</a>
          </div>
        </div>
      </div>
    </div>

    <div id="notificationErrorModal" class="modal fade">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal"></button>
            <h4 class="modal-title">Warning</h4>
          </div>
          <div class="modal-body">
            <p>Some errors occured during notification sending.</p>
          </div>
          <div class="modal-footer">
            <a href="{{ url_for('emailview.index_view') }}" class="btn btn-primary">Ok</a>
          </div>
        </div>
      </div>
    </div>

{% endblock body %}